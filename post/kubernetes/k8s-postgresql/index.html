<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>在 Kubernetes 部署 PostgreSQL | Hanggi - NGNL</title><meta name=keywords content><meta name=description content="Kubernetes是一个开源容器编排系统，用于自动化容器化应用程序的部署，扩展和管理。 在 Kubernetes 上运行 PostgreSQL 数据库是目前经常会讨论到主题，因为 Kubernetes 提供了使用持久卷，有状态集等来配置有状态容器的方法。
本文旨在提供在 Kubernetes 集群上运行 PostgreSQL 数据库的步骤。"><meta name=author content="Hanggi"><link rel=canonical href=https://hanggi.me/post/kubernetes/k8s-postgresql/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://hanggi.me/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hanggi.me/images/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hanggi.me/images/favicon-32x32.png><link rel=apple-touch-icon href=https://hanggi.me/images/apple-touch-icon.png><link rel=mask-icon href=https://hanggi.me/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-128672771-2","auto"),ga("send","pageview"))</script><meta property="og:title" content="在 Kubernetes 部署 PostgreSQL"><meta property="og:description" content="Kubernetes是一个开源容器编排系统，用于自动化容器化应用程序的部署，扩展和管理。 在 Kubernetes 上运行 PostgreSQL 数据库是目前经常会讨论到主题，因为 Kubernetes 提供了使用持久卷，有状态集等来配置有状态容器的方法。
本文旨在提供在 Kubernetes 集群上运行 PostgreSQL 数据库的步骤。"><meta property="og:type" content="article"><meta property="og:url" content="https://hanggi.me/post/kubernetes/k8s-postgresql/"><meta property="og:image" content="https://cdn.discordapp.com/attachments/989268300473192561/1089919441812324482/Hanggi_web3_pioneer_935fecf9-5d1a-4f33-b95f-980a705c45b6.png"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-05-09T11:55:16+09:00"><meta property="article:modified_time" content="2020-05-09T11:55:16+09:00"><meta property="og:site_name" content="Hanggi"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cdn.discordapp.com/attachments/989268300473192561/1089919441812324482/Hanggi_web3_pioneer_935fecf9-5d1a-4f33-b95f-980a705c45b6.png"><meta name=twitter:title content="在 Kubernetes 部署 PostgreSQL"><meta name=twitter:description content="Kubernetes是一个开源容器编排系统，用于自动化容器化应用程序的部署，扩展和管理。 在 Kubernetes 上运行 PostgreSQL 数据库是目前经常会讨论到主题，因为 Kubernetes 提供了使用持久卷，有状态集等来配置有状态容器的方法。
本文旨在提供在 Kubernetes 集群上运行 PostgreSQL 数据库的步骤。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://hanggi.me/post/"},{"@type":"ListItem","position":3,"name":"在 Kubernetes 部署 PostgreSQL","item":"https://hanggi.me/post/kubernetes/k8s-postgresql/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"在 Kubernetes 部署 PostgreSQL","name":"在 Kubernetes 部署 PostgreSQL","description":"Kubernetes是一个开源容器编排系统，用于自动化容器化应用程序的部署，扩展和管理。 在 Kubernetes 上运行 PostgreSQL 数据库是目前经常会讨论到主题，因为 Kubernetes 提供了使用持久卷，有状态集等来配置有状态容器的方法。\n本文旨在提供在 Kubernetes 集群上运行 PostgreSQL 数据库的步骤。\n","keywords":[],"articleBody":"Kubernetes是一个开源容器编排系统，用于自动化容器化应用程序的部署，扩展和管理。 在 Kubernetes 上运行 PostgreSQL 数据库是目前经常会讨论到主题，因为 Kubernetes 提供了使用持久卷，有状态集等来配置有状态容器的方法。\n本文旨在提供在 Kubernetes 集群上运行 PostgreSQL 数据库的步骤。\n准备工作 一个 Kubernetes 集群 理解 Docker 的基础知识 你可以在任何公共云提供商（例如：AWS，Azure，Google云 或是 DigitalOcean 等）上配置Kubernetes集群。\n要在 Kubernetes 上部署 PostgreSQL，我们需要执行以下步骤：\nPostgres Docker 镜像 用于存储 Postgres 配置的 ConfigMap 持久化卷 Persistent Volume PostgreSQL 的 k8s Deployment PostgreSQL 的 k8s Service PostgreSQL Docker 镜像 我们使用官方仓库中的 PostgreSQL 11.7 Docker 镜像。 该映像将提供提供PostgreSQL 自定义配置/环境变量的功能，例如：用户名，密码，数据库名称和路径等。\n配置 PostgreSQL 的 ConfigMap 我们将使用 ConfigMap 来存储 PostgreSQL 相关信息。 在这里，我们在配置映射中使用数据库，用户和密码，部署模板中的PostgreSQL pod将使用该数据库，用户和密码。\npostgres-configmap.yaml:\napiVersion: v1 kind: ConfigMap metadata: name: postgres-config labels: app: postgres namespace: dev data: POSTGRES_DB: postgresdb POSTGRES_USER: postgresadmin POSTGRES_PASSWORD: admin12345 创建 Postgres ConfigMap 资源\n$ kubectl create -f postgres-configmap.yaml configmap \"postgres-config\" created 持久化卷 Persistent Storage Volume 众所周知 Docker 容器本质上是临时的。 容器实例终止后，由容器或容器中生成的所有数据都将丢失。\n为了保存数据，我们将在 Kubernetes 中使用 Persistent Volume 和 Persistent Volume Claim 资源将数据存储在持久存储中。\n在这里，我们使用本地目录/路径作为永久存储资源（/mnt/data）\nkind: PersistentVolume apiVersion: v1 metadata: name: postgres-pv-volume labels: type: local app: postgres spec: storageClassName: manual capacity: storage: 5Gi accessModes: - ReadWriteMany hostPath: path: \"/mnt/data\" --- kind: PersistentVolumeClaim apiVersion: v1 metadata: name: postgres-pv-claim labels: app: postgres spec: storageClassName: manual accessModes: - ReadWriteMany resources: requests: storage: 5Gi 如果你在使用 DigitalOcean，那么你可能不需要 Persistent Volume，因为你的 k8s 中默认会有一个名为 do-block-storage 的 SC。\n所以我们只需一个 PVC：\napiVersion: v1 kind: PersistentVolumeClaim metadata: name: postgres-pvc spec: accessModes: - ReadWriteOnce resources: requests: storage: 5Gi storageClassName: do-block-storage PostgreSQL Deployment 用于 Deployment 的 PostgreSQL 容器使用 PostgreSQL 11.7。 它使用 PostgreSQL 我们先前创建的configmap中的配置，例如：用户名，密码和数据库名称。 它还会挂载从持久卷创建的卷，并声明使 PostgreSQL 容器的数据持久化。\napiVersion: apps/v1 kind: Deployment metadata: name: postgres-deployment spec: strategy: type: Recreate selector: matchLabels: app: postgres replicas: 1 template: metadata: labels: app: postgres spec: containers: - name: postgres image: postgres:11.7 imagePullPolicy: \"IfNotPresent\" ports: - containerPort: 5432 envFrom: - configMapRef: name: postgres-config volumeMounts: - mountPath: /var/lib/postgresql/data name: postgredb volumes: - name: postgredb persistentVolumeClaim: claimName: postgres-pv-claim PostgreSQL 版本选择 对于 Postgres 的版本选择，一般使用最新的大版本下面一号版本的最新 minor 版本。比如，目前本有：12.2、11.7、10.12 和 9.6.17。其中 9.6 的话还有一年就会停止维护，版本 10 将在 2022 年停止维护，以此类推。所以选择目前最高版本 12 下面一号版本 11 或者 10 将是我们的首选。参考\n创建 Postgres deployment：\n$ kubectl create -f postgres-deployment.yaml deployment \"postgres\" created PostgreSQL Service 要访问部署或容器，我们需要暴露 PostgreSQL Deployment。 Kubernetes提供了不同类型的服务，例如 ClusterIP，NodePort 和 LoadBalancer。\n使用 ClusterIP，我们可以在 Kubernetes 中访问 PostgreSQL 服务。 NodePort 可以在 Kubernetes 节点上公开服务端点。 为了从外部访问PostgreSQL，我们则需要使用一个 Load Balancer 服务类型，该服务类型可以在外部公开。\npostgres-service.yaml:\napiVersion: v1 kind: Service metadata: name: postgres-service labels: app: postgres spec: type: NodePort ports: - port: 5432 targetPort: 5432 protocol: TCP selector: app: postgres 创建 Postgres Service：\n$ kubectl create -f postgres-service.yaml service \"postgres\" created 查看运行结果 $ kubectl get svc postgres NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE postgres-service NodePort 10.245.62.239 5432:32312/TCP 6h10m 大功告成！\n问题 如果遇到 Volume 挂在报错，先去看看 postgres 的日志。\n如果遇到以下问题：\ninitdb: directory “/var/lib/postgresql/data” exists but is not empty If you want to create a new database system, either remove or empty the directory “/var/lib/postgresql/data” or run initdb with an argument other than “/var/lib/postgresql/data”.\n说明你的 volume 里已经有其他文件了，这时候只要在挂在的文件夹中创建一个子文件夹就可以：\n在 postgres-configmap.yaml 中添加：\n- name: PGDATA value: /var/lib/postgresql/data/pgdata PostgreSQL 就会使用 pgdata 这个子文件夹。\n","wordCount":"424","inLanguage":"en","datePublished":"2020-05-09T11:55:16+09:00","dateModified":"2020-05-09T11:55:16+09:00","author":{"@type":"Person","name":"Hanggi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hanggi.me/post/kubernetes/k8s-postgresql/"},"publisher":{"@type":"Organization","name":"Hanggi - NGNL","logo":{"@type":"ImageObject","url":"https://hanggi.me/images/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://hanggi.me accesskey=h title="Hanggi (Alt + H)">Hanggi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hanggi.me/categories/ title=categories><span>categories</span></a></li><li><a href=https://hanggi.me/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>在 Kubernetes 部署 PostgreSQL</h1><div class=post-meta><span title='2020-05-09 11:55:16 +0900 KST'>May 9, 2020</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Hanggi</div></header><div class=post-content><p>Kubernetes是一个开源容器编排系统，用于自动化容器化应用程序的部署，扩展和管理。 在 Kubernetes 上运行 PostgreSQL 数据库是目前经常会讨论到主题，因为 Kubernetes 提供了使用持久卷，有状态集等来配置有状态容器的方法。</p><p>本文旨在提供在 Kubernetes 集群上运行 PostgreSQL 数据库的步骤。</p><h2 id=准备工作>准备工作<a hidden class=anchor aria-hidden=true href=#准备工作>#</a></h2><ul><li>一个 Kubernetes 集群</li><li>理解 Docker 的基础知识</li></ul><p>你可以在任何公共云提供商（例如：<a href="https://aws.amazon.com/cn/eks/?nc2=h_ql_prod_ct_eks">AWS</a>，<a href=https://azure.microsoft.com/en-us/services/kubernetes-service/>Azure</a>，<a href=https://cloud.google.com/kubernetes-engine>Google云</a> 或是 <a href=https://m.do.co/c/5b30a1c50226>DigitalOcean</a> 等）上配置Kubernetes集群。</p><p>要在 Kubernetes 上部署 PostgreSQL，我们需要执行以下步骤：</p><ul><li>Postgres Docker 镜像</li><li>用于存储 Postgres 配置的 ConfigMap</li><li>持久化卷 Persistent Volume</li><li>PostgreSQL 的 k8s Deployment</li><li>PostgreSQL 的 k8s Service</li></ul><h2 id=postgresql-docker-镜像>PostgreSQL Docker 镜像<a hidden class=anchor aria-hidden=true href=#postgresql-docker-镜像>#</a></h2><p>我们使用官方仓库中的 PostgreSQL 11.7 Docker 镜像。 该映像将提供提供PostgreSQL 自定义配置/环境变量的功能，例如：用户名，密码，数据库名称和路径等。</p><h2 id=配置-postgresql-的-configmap>配置 PostgreSQL 的 ConfigMap<a hidden class=anchor aria-hidden=true href=#配置-postgresql-的-configmap>#</a></h2><p>我们将使用 ConfigMap 来存储 PostgreSQL 相关信息。 在这里，我们在配置映射中使用数据库，用户和密码，部署模板中的PostgreSQL pod将使用该数据库，用户和密码。</p><p>postgres-configmap.yaml:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-config</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>dev</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>POSTGRES_DB</span>: <span style=color:#ae81ff>postgresdb</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>POSTGRES_USER</span>: <span style=color:#ae81ff>postgresadmin</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>POSTGRES_PASSWORD</span>: <span style=color:#ae81ff>admin12345</span>
</span></span></code></pre></div><p>创建 Postgres ConfigMap 资源</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create -f postgres-configmap.yaml 
</span></span><span style=display:flex><span>configmap <span style=color:#e6db74>&#34;postgres-config&#34;</span> created
</span></span></code></pre></div><h2 id=持久化卷-persistent-storage-volume>持久化卷 Persistent Storage Volume<a hidden class=anchor aria-hidden=true href=#持久化卷-persistent-storage-volume>#</a></h2><p>众所周知 Docker 容器本质上是临时的。 容器实例终止后，由容器或容器中生成的所有数据都将丢失。</p><p>为了保存数据，我们将在 Kubernetes 中使用 Persistent Volume 和 Persistent Volume Claim 资源将数据存储在持久存储中。</p><p>在这里，我们使用本地目录/路径作为永久存储资源（/mnt/data）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolume</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-pv-volume</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>local</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>manual</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>capacity</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>5Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteMany</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hostPath</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;/mnt/data&#34;</span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-pv-claim</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>manual</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>ReadWriteMany</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>5Gi</span>
</span></span></code></pre></div><p>如果你在使用 <a href=https://m.do.co/c/5b30a1c50226>DigitalOcean</a>，那么你可能不需要 Persistent Volume，因为你的 k8s 中默认会有一个名为 <strong>do-block-storage</strong> 的 SC。</p><p>所以我们只需一个 PVC：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>PersistentVolumeClaim</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-pvc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>accessModes</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>ReadWriteOnce</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>resources</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>requests</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>5Gi</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>storageClassName</span>: <span style=color:#ae81ff>do-block-storage</span>
</span></span></code></pre></div><h2 id=postgresql-deployment>PostgreSQL Deployment<a hidden class=anchor aria-hidden=true href=#postgresql-deployment>#</a></h2><p>用于 Deployment 的 PostgreSQL 容器使用 <a href="https://hub.docker.com/layers/postgres/library/postgres/11.7/images/sha256-f89683f6394f4c7022cc1d9b9319ab6bda83e144f9b21ac836dfe6f012508acf?context=explore">PostgreSQL 11.7</a>。 它使用 PostgreSQL 我们先前创建的configmap中的配置，例如：用户名，密码和数据库名称。 它还会挂载从持久卷创建的卷，并声明使 PostgreSQL 容器的数据持久化。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>strategy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>Recreate</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:11.7</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#e6db74>&#34;IfNotPresent&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>envFrom</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>configMapRef</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-config</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/var/lib/postgresql/data</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgredb</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgredb</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>persistentVolumeClaim</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>claimName</span>: <span style=color:#ae81ff>postgres-pv-claim</span>
</span></span></code></pre></div><h3 id=postgresql-版本选择>PostgreSQL 版本选择<a hidden class=anchor aria-hidden=true href=#postgresql-版本选择>#</a></h3><p>对于 Postgres 的版本选择，一般使用最新的大版本下面一号版本的最新 minor 版本。比如，目前本有：12.2、11.7、10.12 和 9.6.17。其中 9.6 的话还有一年就会停止维护，版本 10 将在 2022 年停止维护，以此类推。所以选择目前最高版本 12 下面一号版本 11 或者 10 将是我们的首选。<a href=https://www.postgresql.org/support/versioning/>参考</a></p><p>创建 Postgres deployment：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create -f postgres-deployment.yaml 
</span></span><span style=display:flex><span>deployment <span style=color:#e6db74>&#34;postgres&#34;</span> created
</span></span></code></pre></div><h2 id=postgresql-service>PostgreSQL Service<a hidden class=anchor aria-hidden=true href=#postgresql-service>#</a></h2><p>要访问部署或容器，我们需要暴露 PostgreSQL Deployment。 Kubernetes提供了不同类型的服务，例如 ClusterIP，NodePort 和 LoadBalancer。</p><p>使用 ClusterIP，我们可以在 Kubernetes 中访问 PostgreSQL 服务。 NodePort 可以在 Kubernetes 节点上公开服务端点。 为了从外部访问PostgreSQL，我们则需要使用一个 Load Balancer 服务类型，该服务类型可以在外部公开。</p><p>postgres-service.yaml:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres-service</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>NodePort</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>5432</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>   <span style=color:#f92672>app</span>: <span style=color:#ae81ff>postgres</span>
</span></span></code></pre></div><p>创建 Postgres Service：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create -f postgres-service.yaml 
</span></span><span style=display:flex><span>service <span style=color:#e6db74>&#34;postgres&#34;</span> created
</span></span></code></pre></div><h2 id=查看运行结果>查看运行结果<a hidden class=anchor aria-hidden=true href=#查看运行结果>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl get svc postgres
</span></span><span style=display:flex><span>NAME               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>          AGE
</span></span><span style=display:flex><span>postgres-service   NodePort   10.245.62.239   &lt;none&gt;        5432:32312/TCP   6h10m
</span></span></code></pre></div><p>大功告成！</p><hr><h3 id=问题>问题<a hidden class=anchor aria-hidden=true href=#问题>#</a></h3><p>如果遇到 Volume 挂在报错，先去看看 postgres 的日志。</p><p>如果遇到以下问题：</p><blockquote><p>initdb: directory &ldquo;/var/lib/postgresql/data&rdquo; exists but is not empty
If you want to create a new database system, either remove or empty
the directory &ldquo;/var/lib/postgresql/data&rdquo; or run initdb
with an argument other than &ldquo;/var/lib/postgresql/data&rdquo;.</p></blockquote><p>说明你的 volume 里已经有其他文件了，这时候只要在挂在的文件夹中创建一个子文件夹就可以：</p><p>在 postgres-configmap.yaml 中添加：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>PGDATA</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>value</span>: <span style=color:#ae81ff>/var/lib/postgresql/data/pgdata</span>
</span></span></code></pre></div><p>PostgreSQL 就会使用 <strong>pgdata</strong> 这个子文件夹。</p></div><footer class=post-footer><ul class=post-tags></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 部署 PostgreSQL on twitter" href="https://twitter.com/intent/tweet/?text=%e5%9c%a8%20Kubernetes%20%e9%83%a8%e7%bd%b2%20PostgreSQL&amp;url=https%3a%2f%2fhanggi.me%2fpost%2fkubernetes%2fk8s-postgresql%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 部署 PostgreSQL on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fhanggi.me%2fpost%2fkubernetes%2fk8s-postgresql%2f&amp;title=%e5%9c%a8%20Kubernetes%20%e9%83%a8%e7%bd%b2%20PostgreSQL&amp;summary=%e5%9c%a8%20Kubernetes%20%e9%83%a8%e7%bd%b2%20PostgreSQL&amp;source=https%3a%2f%2fhanggi.me%2fpost%2fkubernetes%2fk8s-postgresql%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 部署 PostgreSQL on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fhanggi.me%2fpost%2fkubernetes%2fk8s-postgresql%2f&title=%e5%9c%a8%20Kubernetes%20%e9%83%a8%e7%bd%b2%20PostgreSQL"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 部署 PostgreSQL on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhanggi.me%2fpost%2fkubernetes%2fk8s-postgresql%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 部署 PostgreSQL on whatsapp" href="https://api.whatsapp.com/send?text=%e5%9c%a8%20Kubernetes%20%e9%83%a8%e7%bd%b2%20PostgreSQL%20-%20https%3a%2f%2fhanggi.me%2fpost%2fkubernetes%2fk8s-postgresql%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 部署 PostgreSQL on telegram" href="https://telegram.me/share/url?text=%e5%9c%a8%20Kubernetes%20%e9%83%a8%e7%bd%b2%20PostgreSQL&amp;url=https%3a%2f%2fhanggi.me%2fpost%2fkubernetes%2fk8s-postgresql%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://hanggi.me>Hanggi - NGNL</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>