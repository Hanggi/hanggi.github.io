<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>在 Kubernetes 上部署 Drone 持续集成环境 | Hanggi - NGNL</title>
<meta name=keywords content="Drone.io,docker,CI">
<meta name=description content="之前已经用 Docker 和 Docker-compose 搭建了 Drone 的持续集成/部署环境。
这次我们将 Drone 部署到 Kubernetes 上。">
<meta name=author content="Me">
<link rel=canonical href=https://hanggi.me/post/deployment/drone-ci-k8s/>
<meta name=google-site-verification content="XYZabc">
<link crossorigin=anonymous href=/assets/css/stylesheet.min.6f60056d44d3f7eb69a4bc6c332b59960f3a995802bded244750232f33713c49.css integrity="sha256-b2AFbUTT9+tppLxsMytZlg86mVgCve0kR1AjLzNxPEk=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://hanggi.me/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://hanggi.me/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://hanggi.me/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://hanggi.me/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://hanggi.me/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.89.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-128672771-2','auto'),ga('send','pageview'))</script><meta property="og:title" content="在 Kubernetes 上部署 Drone 持续集成环境">
<meta property="og:description" content="之前已经用 Docker 和 Docker-compose 搭建了 Drone 的持续集成/部署环境。
这次我们将 Drone 部署到 Kubernetes 上。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://hanggi.me/post/deployment/drone-ci-k8s/"><meta property="og:image" content="https://hanggi.me/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post">
<meta property="article:published_time" content="2020-04-26T08:28:39+09:00">
<meta property="article:modified_time" content="2020-04-26T08:28:39+09:00"><meta property="og:site_name" content="ExampleSite">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://hanggi.me/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name=twitter:title content="在 Kubernetes 上部署 Drone 持续集成环境">
<meta name=twitter:description content="之前已经用 Docker 和 Docker-compose 搭建了 Drone 的持续集成/部署环境。
这次我们将 Drone 部署到 Kubernetes 上。">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://hanggi.me/post/"},{"@type":"ListItem","position":3,"name":"在 Kubernetes 上部署 Drone 持续集成环境","item":"https://hanggi.me/post/deployment/drone-ci-k8s/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"在 Kubernetes 上部署 Drone 持续集成环境","name":"在 Kubernetes 上部署 Drone 持续集成环境","description":"之前已经用 Docker 和 Docker-compose 搭建了 Drone 的持续集成/部署环境。\n这次我们将 Drone 部署到 Kubernetes 上。\n","keywords":["Drone.io","docker","CI"],"articleBody":"之前已经用 Docker 和 Docker-compose 搭建了 Drone 的持续集成/部署环境。\n这次我们将 Drone 部署到 Kubernetes 上。\nDrone 介绍 在官方介绍中 Drone 介绍自己是一个现代化的持续集成和持续交付平台，是面向繁忙的开发团队的自助式持续交付平台。其实就是想表达 Drone 无需过多复杂的配置，就可以轻松部署和搭建测试环境。\n但尝试使用 Drone 会发现，网络上大部分关于 Drone 的教程都是面向老版本的（v0.8），而现在的版本又与这个老版本有很大出入。所以我们就用截至现在最新版本的 drone 搭建集成测试环境，并部署到 k8s 上。\nDrone 主要分为两个部分：\nDrone Server Drone Server 是一个 Drone 的控制管理平台，用于查看现在正在运行中的集成测试结果、终止测试或跳转源码。\nDrone 支持大部分主流代码托管平台（Github, Bitbucket, Gitlab），同时也支持自建平台（Gogs, Gitea）。\nDrone Runner Drone Runner 负责执行实际测试，官方提供了适用于各种运行环境的 Runner。今天要用的就是其中的 Kubernetes Runner。\n在 Kubernetes 上部署 Drone 首先你得有个可以被外网访问的 k8s 集群，至于怎么弄，请自行解决。\n部署 Drone Server 这一步操作的最终目标是将 drone/drone:1.7.0 这个 Docker 镜像部署到 k8s 、暴露出接口并绑定域名（方便 webhook 发送请求）。\n为了达成这个目的我们要创建一个运行 Drone 容器的 Deployment，暴露这个 Deployment 的 Service，以及用于反向代理的 Ingress。配置文件存在 ConfigMap 中。\n所以我们首先需要一个 Ingress 做一个域名解析，内容如下：\napiVersion: networking.k8s.io/v1beta1 kind: Ingress metadata: name: drone-ingress namespace: devops spec: rules: - host: example.com http: paths: - backend: serviceName: drone-service servicePort: 80 path: / 我们的所有操作将在 devops 这个命名空间里进行，替换自己的域名，代理指向 drone-service 这个服务。\n接下来创建 drone-service 服务：\napiVersion: v1 kind: Service metadata: name: drone-service namespace: devops spec: selector: app: drone-server ports: - name: http protocol: TCP port: 8080 targetPort: 80 drone-service 这个服务将使用 drone-server 这个 Deployment，targetPort 将 80 端口暴露给 Ingress，port 的 8080 端口则是为连接 Drone Runner 准备的内部端口。\n最后就是 drone-server，用于运行 Drone Server 容器。\napiVersion: apps/v1 kind: Deployment metadata: name: drone-server namespace: devops spec: selector: matchLabels: app: drone-server replicas: 1 template: metadata: labels: app: drone-server spec: nodeSelector: node-pool: devops containers: - image: drone/drone:1.7.0 imagePullPolicy: Always name: drone-server volumeMounts: - name: drone-server-sqlite-db mountPath: /var/lib/drone envFrom: - configMapRef: name: drone-env volumes: - name: drone-server-sqlite-db hostPath: path: /rc/data/drone nodeSelector 请根据使用的 k8s 情况自行修改，Drone Server 镜像使用最新的 1.7.0，volume 使用节点的本地卷（重启后会丢失所有数据，所以需要的话可以挂在到其他永久卷中）。\n这里最关键的一点就是 envFrom 环境变量，这里面定义了 Drone Server 所需要一些重要参数。以下内容以 github 为例：\napiVersion: v1 kind: ConfigMap metadata: name: drone-env namespace: devops data: DRONE_GITHUB_SERVER: https://github.com DRONE_GITHUB_CLIENT_ID:  DRONE_GITHUB_CLIENT_SECRET:  DRONE_SERVER_HOST:  DRONE_SERVER_PROTO: http DRONE_RPC_SECRET:  DRONE_LOGS_TRACE: 'true' 其中，DRONE_SERVER_HOST、DRONE_SERVER_PROTO、DRONE_RPC_SECRET 最为关键。\n分别是你的 Drone Server 的域名，以及与 Drone Runner 通讯的 secret，其中 secret 可以存储在 k8s secret 里，再次为了方便演示直接写入配置文件中。\nKubernetes Runner 搭建好 Drone Server 后我们要创建 Drone Runner，并连接 Drone Server。\n与上一个教程不同，这次我们要用到 drone/drone-runner-kube 这个官方镜像。Kubernetes Runner 不同于 Docker runner，他会创建 pod，在新建的 pod 上执行完 pipeline 后销毁掉它们。\n因为 Kubernetes Runner 并不需要向外暴露自己的服务，所以我们只需要一个 Deployment。内容如下：\napiVersion: apps/v1 kind: Deployment metadata: name: kube-runner namespace: devops labels: app.kubernetes.io/name: kube-runner spec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: kube-runner template: metadata: labels: app.kubernetes.io/name: kube-runner spec: nodeSelector: node-pool: dev containers: - name: runner image: drone/drone-runner-kube:1.0.0-beta.2 ports: - containerPort: 3000 envFrom: - configMapRef: name: kube-runner-env 与 Drone Server 一样，我们要自行替换 nodeSelector ，尴尬的是截至今天 drone_runner_kube 最新版本是 _1.0.0-beta.2，我已我们直接使用它。\n环境变量如下：\napiVersion: v1 kind: ConfigMap metadata: name: kube-runner-env namespace: devops data: DRONE_RPC_PROTO: http DRONE_RPC_HOST: drone-service.devops:8080 DRONE_RPC_SECRET:  DRONE_NAMESPACE_DEFAULT: devops DRONE_RUNNER_CAPACITY: '2' DRONE_RUNNER_NAME: kube-runner 其中， DRONE_RPC_HOST 要指向上面创建的 drone-service 地址，DRONE_RPC_SECRET 要与 drone-env 中的一致。\nKubernetes Runner 还有一个很重的东西就是 ServiceAccount，因为 Kubernetes Runner 需要创建新的 pod 执行 pipeline 然后销毁他们，所以它需要一个角色赋予他权限。\n我们的 Drone 角色如下：\nkind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: namespace: devops name: kube-runner rules: - apiGroups: - \"\" resources: - secrets verbs: - create - delete - apiGroups: - \"\" resources: - pods - pods/log verbs: - get - create - delete - list - watch - update 创建好角色后就要将角色绑定到我们的 ServiceAcount：\nkind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: kube-runner namespace: devops subjects: - kind: ServiceAccount name: default namespace: devops roleRef: kind: Role name: kube-runner apiGroup: rbac.authorization.k8s.io Monorepo 现在很多项目都会采用一种 Monorepo 的组织方式，就是一个库里面有好几个项目。这时候我们希望 Drone 只执行当前目录下的项目而不是其他的。官方为我们提供了一个解决方案： drone-tree-config。感兴趣可以看一下。\n总结 Drone 给我们带来了简单快速的持续集成部署的方案，在繁忙的工作中可以不必盯着繁杂的配置项苦恼。如果你不想用 Java 系那些强大而笨重的解决方案，想去使用更符合 go 语言风格、更贴近容器化思维的解决方案，那么 Drone 是一个不错的选择。\n","wordCount":"473","inLanguage":"en","datePublished":"2020-04-26T08:28:39+09:00","dateModified":"2020-04-26T08:28:39+09:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hanggi.me/post/deployment/drone-ci-k8s/"},"publisher":{"@type":"Organization","name":"Hanggi - NGNL","logo":{"@type":"ImageObject","url":"https://hanggi.me/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://hanggi.me accesskey=h title="Hanggi (Alt + H)">Hanggi</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://hanggi.me/categories/ title=categories>
<span>categories</span>
</a>
</li>
<li>
<a href=https://hanggi.me/tags/ title=tags>
<span>tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
在 Kubernetes 上部署 Drone 持续集成环境
</h1>
<div class=post-meta><span title="2020-04-26 08:28:39 +0900 +0900">April 26, 2020</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Me
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#drone-%e4%bb%8b%e7%bb%8d aria-label="Drone 介绍">Drone 介绍</a><ul>
<li>
<a href=#drone-server aria-label="Drone Server">Drone Server</a></li>
<li>
<a href=#drone-runner aria-label="Drone Runner">Drone Runner</a></li></ul>
</li>
<li>
<a href=#%e5%9c%a8-kubernetes-%e4%b8%8a%e9%83%a8%e7%bd%b2-drone aria-label="在 Kubernetes 上部署 Drone">在 Kubernetes 上部署 Drone</a><ul>
<li>
<a href=#%e9%83%a8%e7%bd%b2-drone-server aria-label="部署 Drone Server">部署 Drone Server</a></li>
<li>
<a href=#kubernetes-runner aria-label="Kubernetes Runner">Kubernetes Runner</a></li>
<li>
<a href=#monorepo aria-label=Monorepo>Monorepo</a></li></ul>
</li>
<li>
<a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>之前已经用 Docker 和 Docker-compose 搭建了 <a href=/post/deployment/drone-ci>Drone 的持续集成/部署环境</a>。</p>
<p>这次我们将 Drone 部署到 Kubernetes 上。</p>
<h2 id=drone-介绍>Drone 介绍<a hidden class=anchor aria-hidden=true href=#drone-介绍>#</a></h2>
<p>在官方介绍中 Drone 介绍自己是一个现代化的持续集成和持续交付平台，是面向繁忙的开发团队的自助式持续交付平台。其实就是想表达 Drone 无需过多复杂的配置，就可以轻松部署和搭建测试环境。</p>
<p>但尝试使用 Drone 会发现，网络上大部分关于 Drone 的教程都是面向老版本的（v0.8），而现在的版本又与这个老版本有很大出入。所以我们就用截至现在最新版本的 drone 搭建集成测试环境，并部署到 k8s 上。</p>
<p>Drone 主要分为两个部分：</p>
<h3 id=drone-server>Drone Server<a hidden class=anchor aria-hidden=true href=#drone-server>#</a></h3>
<p>Drone Server 是一个 Drone 的控制管理平台，用于查看现在正在运行中的集成测试结果、终止测试或跳转源码。</p>
<p>Drone 支持大部分主流代码托管平台（Github, Bitbucket, Gitlab），同时也支持自建平台（Gogs, Gitea）。</p>
<h3 id=drone-runner>Drone Runner<a hidden class=anchor aria-hidden=true href=#drone-runner>#</a></h3>
<p>Drone Runner 负责执行实际测试，官方提供了适用于各种运行环境的 Runner。今天要用的就是其中的 Kubernetes Runner。</p>
<h2 id=在-kubernetes-上部署-drone>在 Kubernetes 上部署 Drone<a hidden class=anchor aria-hidden=true href=#在-kubernetes-上部署-drone>#</a></h2>
<p>首先你得有个可以被外网访问的 k8s 集群，至于怎么弄，请自行解决。</p>
<h3 id=部署-drone-server>部署 Drone Server<a hidden class=anchor aria-hidden=true href=#部署-drone-server>#</a></h3>
<p>这一步操作的最终目标是将 <code>drone/drone:1.7.0</code> 这个 Docker 镜像部署到 k8s 、暴露出接口并绑定域名（方便 webhook 发送请求）。</p>
<p>为了达成这个目的我们要创建一个运行 Drone 容器的 Deployment，暴露这个 Deployment 的 Service，以及用于反向代理的 Ingress。配置文件存在 ConfigMap 中。</p>
<p>所以我们首先需要一个 Ingress 做一个域名解析，内容如下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.k8s.io/v1beta1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Ingress</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>drone-ingress</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>devops</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>rules</span>:
  - <span style=color:#f92672>host</span>: <span style=color:#ae81ff>example.com</span>
    <span style=color:#f92672>http</span>:
      <span style=color:#f92672>paths</span>:
      - <span style=color:#f92672>backend</span>:
          <span style=color:#f92672>serviceName</span>: <span style=color:#ae81ff>drone-service</span>
          <span style=color:#f92672>servicePort</span>: <span style=color:#ae81ff>80</span>
        <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
</code></pre></div><p>我们的所有操作将在 <code>devops</code> 这个命名空间里进行，替换自己的域名，代理指向 <strong>drone-service</strong> 这个服务。</p>
<p>接下来创建 <strong>drone-service</strong> 服务：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>drone-service</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>devops</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>drone-server</span>
  <span style=color:#f92672>ports</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
    <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
    <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8080</span>
    <span style=color:#f92672>targetPort</span>: <span style=color:#ae81ff>80</span>
</code></pre></div><p><strong>drone-service</strong> 这个服务将使用 <strong>drone-server</strong> 这个 Deployment，<em>targetPort</em> 将 80 端口暴露给 Ingress，<em>port</em> 的 8080 端口则是为连接 Drone Runner 准备的内部端口。</p>
<p>最后就是 <strong>drone-server</strong>，用于运行 Drone Server 容器。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>drone-server</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>devops</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>drone-server</span>
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>drone-server</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>nodeSelector</span>:
        <span style=color:#f92672>node-pool</span>: <span style=color:#ae81ff>devops</span>
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>drone/drone:1.7.0</span>
        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>drone-server</span>
        <span style=color:#f92672>volumeMounts</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>drone-server-sqlite-db</span>
          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/var/lib/drone</span>
        <span style=color:#f92672>envFrom</span>:
        - <span style=color:#f92672>configMapRef</span>:
            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>drone-env</span>
      <span style=color:#f92672>volumes</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>drone-server-sqlite-db</span>
        <span style=color:#f92672>hostPath</span>:
          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/rc/data/drone</span>
</code></pre></div><p><em>nodeSelector</em> 请根据使用的 k8s 情况自行修改，Drone Server 镜像使用最新的 1.7.0，volume 使用节点的本地卷（重启后会丢失所有数据，所以需要的话可以挂在到其他永久卷中）。</p>
<p>这里最关键的一点就是 <em>envFrom</em> 环境变量，这里面定义了 Drone Server 所需要一些重要参数。以下内容以 github 为例：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>drone-env</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>devops</span>
<span style=color:#f92672>data</span>:
  <span style=color:#f92672>DRONE_GITHUB_SERVER</span>: <span style=color:#ae81ff>https://github.com</span>
  <span style=color:#f92672>DRONE_GITHUB_CLIENT_ID</span>: <span style=color:#ae81ff>&lt;github-client-id&gt;</span>
  <span style=color:#f92672>DRONE_GITHUB_CLIENT_SECRET</span>: <span style=color:#ae81ff>&lt;github-client-secret&gt;</span>
  <span style=color:#f92672>DRONE_SERVER_HOST</span>: <span style=color:#ae81ff>&lt;example.com&gt;</span>
  <span style=color:#f92672>DRONE_SERVER_PROTO</span>: <span style=color:#ae81ff>http</span>
  <span style=color:#f92672>DRONE_RPC_SECRET</span>: <span style=color:#ae81ff>&lt;rpc-secret&gt;</span>
  <span style=color:#f92672>DRONE_LOGS_TRACE</span>: <span style=color:#e6db74>&#39;true&#39;</span>
</code></pre></div><p>其中，<strong>DRONE_SERVER_HOST</strong>、<strong>DRONE_SERVER_PROTO</strong>、<strong>DRONE_RPC_SECRET</strong> 最为关键。</p>
<p>分别是你的 Drone Server 的域名，以及与 Drone Runner 通讯的 secret，其中 secret 可以存储在 k8s secret 里，再次为了方便演示直接写入配置文件中。</p>
<h3 id=kubernetes-runner>Kubernetes Runner<a hidden class=anchor aria-hidden=true href=#kubernetes-runner>#</a></h3>
<p>搭建好 Drone Server 后我们要创建 Drone Runner，并连接 Drone Server。</p>
<p>与<a href=/post/deployment/drone-ci>上一个教程</a>不同，这次我们要用到 <code>drone/drone-runner-kube</code> 这个官方镜像。Kubernetes Runner 不同于 Docker runner，他会创建 pod，在新建的 pod 上执行完 pipeline 后销毁掉它们。</p>
<p>因为 Kubernetes Runner 并不需要向外暴露自己的服务，所以我们只需要一个 Deployment。内容如下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kube-runner</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>devops</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>kube-runner</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>kube-runner</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>app.kubernetes.io/name</span>: <span style=color:#ae81ff>kube-runner</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>nodeSelector</span>:
        <span style=color:#f92672>node-pool</span>: <span style=color:#ae81ff>dev</span>
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>runner</span>
        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>drone/drone-runner-kube:1.0.0-beta.2</span>
        <span style=color:#f92672>ports</span>:
        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>3000</span>
        <span style=color:#f92672>envFrom</span>:
        - <span style=color:#f92672>configMapRef</span>:
            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kube-runner-env</span>
</code></pre></div><p>与 Drone Server 一样，我们要自行替换 <em>nodeSelector</em> ，尴尬的是截至今天 <em>drone_runner_kube</em> 最新版本是 _1.0.0-beta.2，我已我们直接使用它。</p>
<p>环境变量如下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kube-runner-env</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>devops</span>
<span style=color:#f92672>data</span>:
  <span style=color:#f92672>DRONE_RPC_PROTO</span>: <span style=color:#ae81ff>http</span>
  <span style=color:#f92672>DRONE_RPC_HOST</span>: <span style=color:#ae81ff>drone-service.devops:8080</span>
  <span style=color:#f92672>DRONE_RPC_SECRET</span>: <span style=color:#ae81ff>&lt;rpc-secret&gt;</span>
  <span style=color:#f92672>DRONE_NAMESPACE_DEFAULT</span>: <span style=color:#ae81ff>devops</span>
  <span style=color:#f92672>DRONE_RUNNER_CAPACITY</span>: <span style=color:#e6db74>&#39;2&#39;</span>
  <span style=color:#f92672>DRONE_RUNNER_NAME</span>: <span style=color:#ae81ff>kube-runner</span>
</code></pre></div><p>其中， <strong>DRONE_RPC_HOST</strong> 要指向上面创建的 drone-service 地址，<strong>DRONE_RPC_SECRET</strong> 要与 drone-env 中的一致。</p>
<p>Kubernetes Runner 还有一个很重的东西就是 ServiceAccount，因为 Kubernetes Runner 需要创建新的 pod 执行 pipeline 然后销毁他们，所以它需要一个角色赋予他权限。</p>
<p>我们的 Drone 角色如下：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>devops</span>
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kube-runner</span>
<span style=color:#f92672>rules</span>:
- <span style=color:#f92672>apiGroups</span>:
  - <span style=color:#e6db74>&#34;&#34;</span>
  <span style=color:#f92672>resources</span>:
  - <span style=color:#ae81ff>secrets</span>
  <span style=color:#f92672>verbs</span>:
  - <span style=color:#ae81ff>create</span>
  - <span style=color:#ae81ff>delete</span>
- <span style=color:#f92672>apiGroups</span>:
  - <span style=color:#e6db74>&#34;&#34;</span>
  <span style=color:#f92672>resources</span>:
  - <span style=color:#ae81ff>pods</span>
  - <span style=color:#ae81ff>pods/log</span>
  <span style=color:#f92672>verbs</span>:
  - <span style=color:#ae81ff>get</span>
  - <span style=color:#ae81ff>create</span>
  - <span style=color:#ae81ff>delete</span>
  - <span style=color:#ae81ff>list</span>
  - <span style=color:#ae81ff>watch</span>
  - <span style=color:#ae81ff>update</span>
</code></pre></div><p>创建好角色后就要将角色绑定到我们的 ServiceAcount：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>RoleBinding</span>
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io/v1</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kube-runner</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>devops</span>
<span style=color:#f92672>subjects</span>:
- <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ServiceAccount</span>
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>default</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>devops</span>
<span style=color:#f92672>roleRef</span>:
  <span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Role</span>
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>kube-runner</span>
  <span style=color:#f92672>apiGroup</span>: <span style=color:#ae81ff>rbac.authorization.k8s.io</span>
</code></pre></div><h3 id=monorepo>Monorepo<a hidden class=anchor aria-hidden=true href=#monorepo>#</a></h3>
<p>现在很多项目都会采用一种 Monorepo 的组织方式，就是一个库里面有好几个项目。这时候我们希望 Drone 只执行当前目录下的项目而不是其他的。官方为我们提供了一个解决方案： <strong>drone-tree-config</strong>。感兴趣可以看一下。</p>
<h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2>
<p>Drone 给我们带来了简单快速的持续集成部署的方案，在繁忙的工作中可以不必盯着繁杂的配置项苦恼。如果你不想用 Java 系那些强大而笨重的解决方案，想去使用更符合 go 语言风格、更贴近容器化思维的解决方案，那么 Drone 是一个不错的选择。</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://hanggi.me/tags/drone.io/>Drone.io</a></li>
<li><a href=https://hanggi.me/tags/docker/>docker</a></li>
<li><a href=https://hanggi.me/tags/ci/>CI</a></li>
</ul>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 上部署 Drone 持续集成环境 on twitter" href="https://twitter.com/intent/tweet/?text=%e5%9c%a8%20Kubernetes%20%e4%b8%8a%e9%83%a8%e7%bd%b2%20Drone%20%e6%8c%81%e7%bb%ad%e9%9b%86%e6%88%90%e7%8e%af%e5%a2%83&url=https%3a%2f%2fhanggi.me%2fpost%2fdeployment%2fdrone-ci-k8s%2f&hashtags=Drone.io%2cdocker%2cCI"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 上部署 Drone 持续集成环境 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fhanggi.me%2fpost%2fdeployment%2fdrone-ci-k8s%2f&title=%e5%9c%a8%20Kubernetes%20%e4%b8%8a%e9%83%a8%e7%bd%b2%20Drone%20%e6%8c%81%e7%bb%ad%e9%9b%86%e6%88%90%e7%8e%af%e5%a2%83&summary=%e5%9c%a8%20Kubernetes%20%e4%b8%8a%e9%83%a8%e7%bd%b2%20Drone%20%e6%8c%81%e7%bb%ad%e9%9b%86%e6%88%90%e7%8e%af%e5%a2%83&source=https%3a%2f%2fhanggi.me%2fpost%2fdeployment%2fdrone-ci-k8s%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 上部署 Drone 持续集成环境 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fhanggi.me%2fpost%2fdeployment%2fdrone-ci-k8s%2f&title=%e5%9c%a8%20Kubernetes%20%e4%b8%8a%e9%83%a8%e7%bd%b2%20Drone%20%e6%8c%81%e7%bb%ad%e9%9b%86%e6%88%90%e7%8e%af%e5%a2%83"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 上部署 Drone 持续集成环境 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhanggi.me%2fpost%2fdeployment%2fdrone-ci-k8s%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 上部署 Drone 持续集成环境 on whatsapp" href="https://api.whatsapp.com/send?text=%e5%9c%a8%20Kubernetes%20%e4%b8%8a%e9%83%a8%e7%bd%b2%20Drone%20%e6%8c%81%e7%bb%ad%e9%9b%86%e6%88%90%e7%8e%af%e5%a2%83%20-%20https%3a%2f%2fhanggi.me%2fpost%2fdeployment%2fdrone-ci-k8s%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 在 Kubernetes 上部署 Drone 持续集成环境 on telegram" href="https://telegram.me/share/url?text=%e5%9c%a8%20Kubernetes%20%e4%b8%8a%e9%83%a8%e7%bd%b2%20Drone%20%e6%8c%81%e7%bb%ad%e9%9b%86%e6%88%90%e7%8e%af%e5%a2%83&url=https%3a%2f%2fhanggi.me%2fpost%2fdeployment%2fdrone-ci-k8s%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://hanggi.me>Hanggi - NGNL</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>